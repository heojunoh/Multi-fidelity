### Park Example ###
library(lhs)
library(laGP)
source("GP.R")
source("closed.R")
source("score.R")

eps <- sqrt(.Machine$double.eps)


X1 <- rbind(c(.000550, 315.00, 310.00, 365.00),
            c(.000552, 293.53, 318.63, 388.29),
            c(.000566, 285.77, 266.71, 367.27),
            c(.000578, 302.17, 358.13, 343.72),
            c(.000580, 272.26, 211.71, 333.65),
            # c(.000589, 278.16, 225.78, 351.83),
            c(.000612, 280.83, 291.53, 394.72),
            c(.000626, 284.89, 350.46, 352.29),
            c(.000639, 270.45, 241.21, 341.81),
            c(.000643, 276.17, 216.99, 371.60),
            c(.000652, 298.04, 303.96, 361.58),
            # c(.000700, 288.15, 300.00, 400.00),
            c(.000751, 287.99, 326.02, 354.08),
            c(.000780, 292.73, 267.84, 369.00),
            c(.000800, 303.15, 250.00, 350.00),
            c(.000814, 286.39, 339.92, 332.40),
            c(.000842, 294.39, 203.45, 346.05),
            # c(.000850, 301.31, 317.85, 341.00),
            c(.000857, 282.12, 262.30, 350.10),
            c(.000903, 284.25, 290.90, 364.99),
            c(.000910, 248.87, 206.74, 398.00),
            c(.000940, 271.32, 362.73, 400.00),
            c(.000950, 280.00, 270.00, 330.00),
            # c(.001000, 293.15, 202.40, 373.15),
            c(.000669, 296.33, 343.16, 385.81),
            c(.000670, 303.07, 321.41, 370.48),
            c(.000683, 287.05, 227.31, 358.24),
            c(.000689, 272.70, 260.91, 355.37),
            c(.000694, 278.35, 212.79, 376.24),
            # c(.000698, 277.52, 299.39, 338.40),
            c(.000711, 292.26, 273.31, 392.54),
            c(.000714, 283.08, 306.69, 344.34),
            c(.000722, 276.53, 353.75, 374.41),
            c(.000730, 285.51, 217.74, 383.92),
            c(.000738, 295.01, 295.02, 347.22)#,
            # c(.000741, 270.95, 275.19, 356.87)
            )

y1 <- c(7.02, 25.61, 21.23, 11.44, 15.03, 
        # 18.55, 
        30.22, 18.13, 17.92, 24.20, 17.47, 
        # 30.90,
        18.17, 20.92, 13.08, 12.68, 13.75, 
        # 11.30, 
        18.25, 22.22, 36.56, 35.53, 13.54, 
        # 21.60,
        25.07, 18.93, 18.61, 21.31, 25.11, 
        # 16.02, 
        27.47, 16.43, 26.50, 25.88, 14.37#, 
        # 22.36
        )

X2 <- rbind(c(.000550, 315.00, 310.00, 365.00),
            c(.000552, 293.53, 318.63, 388.29),
            c(.000566, 285.77, 266.71, 367.27),
            c(.000578, 302.17, 358.13, 343.72),
            c(.000580, 272.26, 211.71, 333.65),
            # c(.000589, 278.16, 225.78, 351.83),
            c(.000612, 280.83, 291.53, 394.72),
            c(.000626, 284.89, 350.46, 352.29),
            c(.000639, 270.45, 241.21, 341.81),
            c(.000643, 276.17, 216.99, 371.60),
            c(.000652, 298.04, 303.96, 361.58),
            # c(.000700, 288.15, 300.00, 400.00),
            c(.000751, 287.99, 326.02, 354.08),
            c(.000780, 292.73, 267.84, 369.00),
            c(.000800, 303.15, 250.00, 350.00),
            c(.000814, 286.39, 339.92, 332.40),
            c(.000842, 294.39, 203.45, 346.05),
            # c(.000850, 301.31, 317.85, 341.00),
            c(.000857, 282.12, 262.30, 350.10),
            c(.000903, 284.25, 290.90, 364.99),
            c(.000910, 248.87, 206.74, 398.00),
            c(.000940, 271.32, 362.73, 400.00),
            c(.000950, 280.00, 270.00, 330.00)#,
            # c(.001000, 293.15, 202.40, 373.15)
            )

y2 <- c(7.48, 23.54, 20.15, 10.17, 15.29, 
        # 18.39, 
        30.12, 18.17, 19.05, 24.96, 16.95, 
        # 34.45,
        19.57, 21.97, 14.83, 14.36, 15.12, 
        # 11.92, 
        21.31, 25.37, 47.05, 42.93, 17.41#, 
        # 22.89
        )

NestDesign <- NestedDesignBuild(design = list(X1,X2))
NestDesign$PX <- X1
NestDesign$ind[[1]] <- c(1:20)#[-c(11,12,15,16,19)]#c(1,2,3,4,5,6,8,9,10,12,13,14,15,16,17,18,20,21,22,24)

NestDesign$PX == X1
NestDesign$PX[NestDesign$ind[[1]],] == X2

Xtest <- rbind(c(.000500, 293.15, 362.73, 393.15),
               c(.000560, 277.01, 354.98, 374.00),
               c(.000594, 279.54, 258.51, 360.13),
               c(.000620, 275.00, 225.00, 340.00),
               c(.000627, 287.60, 243.96, 382.54),
               c(.000657, 294.24, 330.63, 375.53),
               c(.000680, 313.28, 259.12, 350.00),
               c(.000763, 292.82, 254.84, 373.38),
               c(.000850, 270.00, 325.00, 385.00),
               c(.000851, 273.71, 315.27, 381.14),
               c(.000874, 282.50, 253.25, 396.36),
               c(.000882, 299.22, 288.45, 385.07))

ytest <- c(25.82, 19.77, 20.52, 18.78, 24.68, 22.30, 4.55, 23.33, 32.85, 34.80, 36.11, 27.36)


### closed ###
tic.closed <- proc.time()[3]
fit.closed <- closed(X1, y1, X2, y2, constant=TRUE)
predy <- predclosed(fit.closed, Xtest)$mu
predsig2 <- predclosed(fit.closed, Xtest)$sig2
toc.closed <- proc.time()[3]

### Cokriging ###
tic.cokm <- proc.time()[3]
fit.muficokm <- MuFicokm(formula = list(~1,~1), MuFidesign = NestDesign, covtype="gauss",
                         lower=eps, #upper=0.1,
                         coef.trend = list(0,c(0,0)), response = list(y1,y2), nlevel = 2)
pred.muficokm <- predict(fit.muficokm, Xtest, "SK")
toc.cokm <- proc.time()[3]


### error ###
# pred.qian <- c(23.57, 23.61, 20.20, 16.81, 26.01, 22.76, 10.52, 23.18, 37.07, 34.33, 35.90, 26.04)
pred.NARGP <- c(14.92162539,19.84073412,17.27187817,18.88299501,20.1570272 ,15.83994059,16.76346409,15.79469007,20.83438869,14.73290805,21.45458027,14.75842077)
sig2.NARGP <- c(724.53723299,752.24855402,849.60368296,887.62169427,785.05930603,901.31062603,726.74474702,819.47061361,913.51038994,823.73209643,903.82709895,824.02183953)
### SRMSE ###
sqrt(sum(((predy-ytest)/ytest)^2)/12) # closed form 0.3124651
sqrt(sum(((pred.muficokm$mean-ytest)/ytest)^2)/12) # Cokm 0.3561139
sqrt(sum(((pred.NARGP-ytest)/ytest)^2)/12) # NARGP 0.840317
# sqrt(sum(((pred.qian-ytest)/ytest)^2)/12) # Qian 0.3873585

### RMSE ###
sqrt(mean((predy-ytest)^2)) # 2.733367
sqrt(mean((pred.muficokm$mean-ytest)^2)) # 2.842415
sqrt(mean((pred.NARGP-ytest)^2)) # 10.48063
# sqrt(mean((pred.qian-ytest)^2)) # 2.6021

### mean CRPS ###
mean(crps(ytest, predy, predsig2)) # 1.858086
mean(crps(ytest, pred.muficokm$mean, pred.muficokm$sig2)) # 1.816957
mean(crps(ytest, pred.NARGP, predsig2)) # 8.562537


# sqrt(sum(((predy[-7]-ytest[-7])/ytest[-7])^2)/11) # closed form 0.1064936
# sqrt(sum(((pred.muficokm$mean[-7]-ytest[-7])/ytest[-7])^2)/11) # Cokm 0.07602347
# sqrt(sum(((pred.NARGP[-7]-ytest[-7])/ytest[-7])^2)/11) # Cokm 0.07602347
# sqrt(sum(((c(23.57, 23.61, 20.20, 16.81, 26.01, 22.76, 23.18, 37.07, 34.33, 35.90, 26.04)-ytest[-7])/ytest[-7])^2)/11) # Qian 0.08473748
# sqrt(sum(((c(23.22, 26.67, 22.26, 16.32, 23.76, 20.32, 21.65, 34.38, 31.75, 31.10, 21.36)-ytest[-7])/ytest[-7])^2)/11) # single 0.1501362
# sqrt(sum(((c(24.20, 25.00, 20.46, 17.29, 24.82, 21.90, 22.67, 35.80, 33.28, 35.86, 26.15)-ytest[-7])/ytest[-7])^2)/11) # qian 0.09212281
# sqrt(sum(((c(28.66, 22.97, 20.24, 17.34, 25.86, 21.76, 22.94, 33.85, 31.89, 34.87, 25.49)-ytest[-7])/ytest[-7])^2)/11) # ko 0.07464131


# mean(score(ytest, predy, predsig2)) # closed form -63.61671
# mean(score(ytest, pred.muficokm$mean, pred.muficokm$sig2)) # Cokriging -30.81238

mean(crps(ytest, predy, predsig2)) # closed form 1.600653
mean(crps(ytest, pred.muficokm$mean, pred.muficokm$sig2)) # Cokriging 2.165902

toc.closed - tic.closed # 0.177
toc.cokm - tic.cokm # 0.068


qianrmse <- c(0.02934815, 0.03828294, 0.09120226222849993)
qianscore <- c(-63.61671, -30.81238, -11.842220158512275)
qiancrps <- c(1.600653, 2.165902, 1.3689292766352918)
qiantime <- c(0.18, 0.076, 6.336800813674927)


